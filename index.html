<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Minecraft Bedrock Skin Pack Generator</title>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
    margin:0;padding:16px;background:#f7f7fb;color:#111;
  }
  h1{margin:0 0 12px;font-size:20px}
  .panel{
    background:#fff;padding:16px;border-radius:10px;
    box-shadow:0 6px 18px rgba(15,18,40,0.06);
    max-width:100%;box-sizing:border-box;
  }
  label{display:block;margin:8px 0 4px;font-weight:600}

  input[type="text"], input[type="file"], select{
    width:100%;padding:8px;border:1px solid #ddd;
    border-radius:6px;box-sizing:border-box;
  }

  /* input:file の長さ対策 */
  input[type="file"]{
    white-space:normal; 
  }

  .skins-list{margin-top:12px}

  .skin-item{
    display:flex;flex-wrap:wrap;gap:12px;
    border:1px dashed #eee;padding:12px;border-radius:8px;
    margin-bottom:12px;box-sizing:border-box;
  }

  .skin-thumb{
    width:64px;height:64px;border-radius:6px;
    object-fit:contain;background:#fafafa;border:1px solid #eee;
    flex-shrink:0;
  }

  .skin-fields{
    flex:1;min-width:200px;width:100%;
  }

  .row{
    display:flex;gap:8px;flex-wrap:wrap;width:100%;
  }

  .row > *{
    flex:1 1 120px;min-width:0;
  }

  button{
    padding:10px 14px;border-radius:8px;border:0;
    background:#2563eb;color:#fff;font-weight:600;
    cursor:pointer;width:100%;box-sizing:border-box;
  }
  button.secondary{background:#e6e9f2;color:#111}

  .btn-row{display:flex;gap:8px;flex-wrap:wrap}
  .btn-row button{flex:1 1 200px}
</style>
</head>

<body>
<div class="panel">
  <h1>Bedrock Skin Pack Generator<br>(EN + JP)</h1>

  <label>スキンパック名（英語 / 必須）</label>
  <input id="packNameEn" type="text" placeholder="Example: My Skin Pack">

  <label>スキンパック名（日本語 / 任意）</label>
  <input id="packNameJp" type="text" placeholder="例: マイスキンパック">

  <div class="btn-row" style="margin-top:12px;">
    <button id="addSkinBtn" class="secondary">スキンを追加</button>
    <button id="exportBtn">Export .mcpack</button>
  </div>

  <div class="skins-list" id="skinsList"></div>
</div>

<script>
function uuidv4(){
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
    const r=crypto.getRandomValues(new Uint8Array(1))[0]&15;
    const v=c==='x'?r:(r&3|8);
    return v.toString(16);
  });
}

// 乱数でパックキー自動生成
function generatePackKey(){
  return "pack_" + Math.floor(100000 + Math.random()*900000);
}

const skinsList=document.getElementById("skinsList");
document.getElementById("addSkinBtn").onclick=()=>addSkinItem();

let skinId=0;
function addSkinItem(){
  skinId++;
  const div=document.createElement("div");
  div.className="skin-item";
  div.innerHTML=`
    <img class="skin-thumb" src="" />

    <div class="skin-fields">
      <div class="row">
        <input type="file" accept="image/png" class="skin-file">
        <select class="arm-choice">
          <option value="normal">普通腕</option>
          <option value="slim">スリム腕</option>
        </select>
      </div>

      <div class="row" style="margin-top:8px;">
        <input type="text" class="skinNameEn" placeholder="スキン名（英語必須）">
        <input type="text" class="skinNameJp" placeholder="スキン名（日本語任意）">
      </div>
    </div>

    <button class="secondary removeBtn">削除</button>
  `;
  skinsList.appendChild(div);

  const fileInput=div.querySelector(".skin-file");
  const thumb=div.querySelector(".skin-thumb");
  fileInput.onchange=e=>{
    const f=e.target.files[0];if(!f)return;
    const r=new FileReader();
    r.onload=()=>thumb.src=r.result;
    r.readAsDataURL(f);
  };
  div.querySelector(".removeBtn").onclick=()=>div.remove();
}

addSkinItem(); // 最初の1つ

document.getElementById("exportBtn").onclick=async()=>{
  const nameEn=document.getElementById("packNameEn").value.trim();
  const nameJp=document.getElementById("packNameJp").value.trim();
  if(!nameEn){alert("英語パック名は必須です");return;}

  const packKey=generatePackKey(); // ★自動生成

  const nodes=[...document.querySelectorAll(".skin-item")];
  if(nodes.length===0){alert("スキンを追加してください");return;}

  const skins=[];
  for(const n of nodes){
    const file=n.querySelector(".skin-file").files[0];
    const en=n.querySelector(".skinNameEn").value.trim();
    const jp=n.querySelector(".skinNameJp").value.trim();
    const arm=n.querySelector(".arm-choice").value;

    if(!file){alert("画像が指定されていません");return;}
    if(!en){alert("スキン名（英語）は必須です");return;}

    const buf=await file.arrayBuffer();
    skins.push({
      fileName:file.name.replace(/\s+/g,"_"),
      blob:new Blob([buf],{type:"image/png"}),
      en,jp,key:en.toLowerCase().replace(/[^a-z0-9_]/g,"_"),
      arm
    });
  }

  const manifest={
    format_version:2,
    header:{name:nameEn,uuid:uuidv4(),version:[1,0,0]},
    modules:[{type:"skin_pack",uuid:uuidv4(),version:[1,0,0]}]
  };

  const skinsJson={
    serialize_name:nameEn,
    localization_name:packKey,
    skins:skins.map(s=>({
      localization_name:s.key,
      geometry:s.arm==="slim"?"geometry.humanoid.customSlim":"geometry.humanoid.custom",
      texture:s.fileName,
      type:"free"
    }))
  };

  let enLang=`skinpack.${packKey}=${nameEn}\n\n`;
  let jpLang=`skinpack.${packKey}=${nameJp||nameEn}\n\n`;
  skins.forEach(s=>{
    enLang+=`skin.${packKey}.${s.key}=${s.en}\n`;
    jpLang+=`skin.${packKey}.${s.key}=${s.jp||s.en}\n`;
  });

  const zip=new JSZip();
  zip.file("manifest.json",JSON.stringify(manifest,null,2));
  zip.file("skins.json",JSON.stringify(skinsJson,null,2));
  zip.folder("texts").file("en_US.lang",enLang);
  zip.folder("texts").file("ja_JP.lang",jpLang);
  skins.forEach(s=>zip.file(s.fileName,s.blob));

  const blob=await zip.generateAsync({type:"blob"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=nameEn.replace(/[^a-zA-Z0-9_-]/g,"_")+".mcpack";
  a.click();
};
</script>

</body>
</html>
